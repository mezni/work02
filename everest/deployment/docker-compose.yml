name: everest
services:
  # ========================
  # Keycloak DB
  # ========================
  kc-db:
    image: postgres:18.1-alpine
    container_name: kc-db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password
    volumes:
      - kc-data:/var/lib/postgresql/data
    networks:
      - ev-network
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "keycloak", "-d", "keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================
  # Keycloak
  # ========================
  keycloak:
    image: quay.io/keycloak/keycloak:26.0.1
    container_name: keycloak
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://kc-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: password
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: password
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
    ports:
      - "5080:8080"  # host port 5080 maps to container 8080
    depends_on:
      kc-db:
        condition: service_healthy
    volumes:
      - ./keycloak/config.json:/opt/keycloak/data/import/config.json
    command: start-dev --import-realm
    networks:
      - ev-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/realms/myrealm"]
      interval: 10s
      retries: 10
      start_period: 15s

  # ========================
  # EVCS DB
  # ========================
  evcs-db:
    image: postgis/postgis:18-3.6
    container_name: evcs-db
    environment:
      POSTGRES_DB: evcs_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "6100:5432"
    volumes:
      - evcs-data:/var/lib/postgresql
      - ./databases/evcs-db/:/docker-entrypoint-initdb.d/:ro
    networks:
      - ev-network
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres", "-d", "evcs_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================
  # Auth DB
  # ========================
  auth-db:
    image: postgres:18.1-alpine
    container_name: auth-db
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "6200:5432"
    volumes:
      - auth-data:/var/lib/postgresql/data
      - ./databases/auth-db/:/docker-entrypoint-initdb.d/:ro
    networks:
      - ev-network
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres", "-d", "auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================
  # OSM Importer
  # ========================
  osm-importer:
    build:
      context: ./tools/osm-importer
      dockerfile: Dockerfile
    container_name: osm-importer
    depends_on:
      evcs-db:
        condition: service_healthy
    environment:
      PGHOST: evcs-db
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: password
      PGDATABASE: evcs_db
      REGION: tunisia
      DATADIR: /osm/data
    volumes:
      - ./tools/data:/osm/data
    networks:
      - ev-network

  # ========================
  # Auth Service
  # ========================
  auth-service:
    build: ../services/auth-service
    container_name: auth-service
    environment:
      - DATABASE_URL=postgresql://postgres:password@auth-db:5432/auth_db
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=3000
      - RUST_LOG=info
      - KEYCLOAK_URL=http://keycloak:5080        
      - KEYCLOAK_REALM=myrealm
      - KEYCLOAK_AUTH_CLIENT_ID=auth-client
      - KEYCLOAK_BACKEND_CLIENT_ID=backend-admin
      - KEYCLOAK_BACKEND_CLIENT_SECRET=backend-admin-secret
    ports:
      - "3100:3000"
    depends_on:
      auth-db:
        condition: service_healthy
#      keycloak:
#        condition: service_healthy
    networks:
      - ev-network

  # ========================
  # Locate Service
  # ========================
  locate-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: locate-service
    environment:
      DATABASE_URL: postgresql://locate_user:locate_password@postgres:5432/locate_db
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8080
      JWT_ISSUER: http://localhost:5080/realms/myrealm
      JWKS_URL: http://keycloak:8080/realms/myrealm/protocol/openid-connect/certs
      RUST_LOG: locate_service=debug,actix_web=info
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - locate-network
    restart: unless-stopped

# ========================
# Volumes
# ========================
volumes:
  evcs-data:
  auth-data:
  kc-data:

# ========================
# Networks
# ========================
networks:
  ev-network:
    driver: bridge
