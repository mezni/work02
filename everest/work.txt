Auth Service: summary
- This service is NOT a login system.
- It is a security backbone that:
Delegates authentication & passwords to Keycloak
Owns authorization, user metadata, and auditing
Issues and validates JWT tokens trusted by all other services
Passwords are NEVER stored or handled here.


2 Core Responsibilities: This service MUST do the following:
- Manage users (external & internal)
- Enforce role + scope rules
- Validate Keycloak JWT tokens
- Sync users between Keycloak and PostgreSQL
- Record all security-relevant actions
- Expose a clean HTTP API with Swagger

3- Authority Model
| Concern                                  | Authority                |
| ---------------------------------------- | ------------------------ |
| Identity (email, password, verification) | **Keycloak**             |
| Authorization (roles, scope, metadata)   | **PostgreSQL**           |
| Tokens                                   | **Keycloak-issued JWTs** |
| Validation                               | **Auth Service**         |
Keycloak = Identity source of truth
PostgreSQL = Business source of truth

4- User Types & Rules
- External Users (Self-Registration)
Endpoint: POST /api/v1/auth/register
Role: user
Source: web
network_id = X, station_id = X
Email verification handled by Keycloak
Stored in DB after Keycloak creation

- Internal Users (Admin-Created)
Endpoint: POST /api/v1/admin/users
Source: internal
Allowed roles:
admin
partner → must have network_id
operator → must have network_id + station_id
Created in DB + synced to Keycloak

5- JWT Tokens (Critical)
JWTs are issued by Keycloak and MUST contain:
user_id (from DB)
roles
network_id
station_id
ex: {
  "sub": "keycloak-user-id",
  "user_id": "USR-xxxxxxxxxxxxx",
  "roles": ["admin", "partner", "operator", "user"],
  "network_id": "NET-xxx",
  "station_id": "STA-xxx",
  "iss": "https://keycloak/auth/realms/your-realm",
  "exp": 1710000000,
  "iat": 1709990000
}


Your service MUST:
Validate JWT signature
Cache Keycloak public keys in memory
Extract claims
Enforce permissions
No database lookup is required for normal authorization


6- env variables 
DATABASE_URL=postgresql://postgres:password@localhost:6200/auth_db
SERVER_HOST=0.0.0.0 (optional)
SERVER_PORT=3000 (optional)
RUST_LOG=info (optional)

# Keycloak Configuration
KEYCLOAK_URL=http://localhost:5080
KEYCLOAK_REALM=myrealm

# Frontend client (public, for user authentication)
KEYCLOAK_AUTH_CLIENT_ID=auth-client

# Backend service account (confidential, for admin operations)
KEYCLOAK_BACKEND_CLIENT_ID=backend-admin
KEYCLOAK_BACKEND_CLIENT_SECRET=backend-admin-secret


7- API Surface (Required)
Public
POST /api/v1/auth/register
GET /api/v1/health
GET /api/v1/swagger-ui

User
GET /api/v1/users/me
PUT /api/v1/users/me

Admin
POST /api/v1/admin/users
GET /api/v1/admin/users
GET /api/v1/admin/users?search=...
PUT /api/v1/admin/users/{id}
DELETE /api/v1/admin/users/{id} (soft delete)

8- Background Job
A scheduled job runs every few minutes to:
Fetch users from Keycloak
Sync roles, status, attributes into DB
Detect and log changes
This keeps DB and Keycloak consistent.

9- project structure
src/
├── core/            # Shared utilities (config, logging, jwt, ids)
├── domain/          # Business rules only
├── application/     # Use cases (services, commands, queries)
├── infrastructure/  # DB, Keycloak, cache implementations
├── interfaces/      # HTTP handlers, routes, Swagger
├── main.rs
├── lib.rs


src/
├── main.rs
├── lib.rs
├── core/
│   ├── config.rs
│   ├── logging.rs
│   ├── errors.rs
│   ├── database.rs
│   ├── jwt.rs          # JWT validation & claim extraction
│   └── id_generator.rs        # nanoid, time helpers

├── domain/
│   ├── entities.rs     # User, Role
│   ├── value_objects.rs
│   ├── repositories.rs
│   └── events.rs

├── application/
│   ├── dtos.rs
│   ├── commands.rs
│   ├── queries.rs
│   └── services.rs

├── infrastructure/
│   ├── persistence.rs  # SQLx repositories
│   ├── keycloak.rs     # Keycloak client
│   └── cache.rs        # In-memory cache

├── interfaces/
│   ├── handlers.rs
│   ├── routes.rs
│   └── openapi.rs


10- Layer Rules (DO NOT BREAK)
❌ No business logic in HTTP handlers
❌ No DB access outside repositories
❌ No Keycloak calls outside infrastructure
✅ Application layer orchestrates everything
✅ Domain layer enforces invariants

Hard Rules (Never Violate)
❌ Never store passwords
❌ Never trust client roles
❌ Never bypass Keycloak
❌ Never mix layers
✅ Always audit admin actions
✅ Always sync DB & Keycloak
✅ Soft delete users only

11- Tech Stack (Fixed)
Rust
Actix-Web
SQLx + PostgreSQL  (use dynamic queries)
Keycloak
tracing
dotenvy
anyhow + thiserror
utoipa + Swagger UI
In-memory cache (HashMap / DashMap)
nanoid for IDs

12- ID Strategy

All IDs are NanoID-based
Prefixes:
USR- → users
AUD- → audits
IDs are generated in core/id_generator.rs. nanoid(16)