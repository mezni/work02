src/
├── main.rs
├── lib.rs

├── core/
│   ├── mod.rs
│   ├── config.rs
│   ├── logging.rs
│   ├── errors.rs
│   ├── database.rs
│   ├── jwt.rs          # JWT validation & claims helpers
│   └── tools.rs        # Time + ID generators

├── domain/
│   ├── mod.rs
│   ├── value_objects.rs
│   ├── entities.rs
│   ├── repositories.rs
│   └── events.rs

├── application/
│   ├── mod.rs
│   ├── dtos.rs
│   ├── commands.rs
│   ├── queries.rs
│   └── services.rs

├── infrastructure/
│   ├── mod.rs
│   ├── persistence.rs
│   ├── keycloak.rs
│   └── cache.rs

├── interfaces/
│   ├── mod.rs
│   ├── openapi.rs
│   ├── handlers.rs
│   └── routes.rs


        


Here’s a full, professional README.md for your auth-service project based on everything we’ve designed so far, including architecture, endpoints, setup, and usage.

# Auth Service

**Auth Service** is a production-ready authentication and user management microservice written in Rust.  
It integrates with **Keycloak** for authentication and role management and uses **PostgreSQL** as the primary database.  

The service follows **DDD architecture** with layered design, CQRS-style commands and queries, audit logging, caching, and Swagger documentation.

---

## Table of Contents

- [Features](#features)  
- [Architecture](#architecture)  
- [Endpoints](#endpoints)  
- [Tech Stack](#tech-stack)  
- [Setup & Run](#setup--run)  
- [Environment Variables](#environment-variables)  
- [Database Migrations](#database-migrations)  
- [Swagger / OpenAPI](#swagger--openapi)  
- [Bi-directional Keycloak Sync](#bi-directional-keycloak-sync)  
- [Audit Logging](#audit-logging)  
- [License](#license)  

---

## Features

- **User Management**
  - Self-registration for external users (role=user)
  - Admin-created users with roles: admin, partner, operator
  - Role-based constraints: network_id and station_id
  - Full CRUD operations
- **Authentication**
  - JWT tokens with roles and attributes (`network_id`, `station_id`)
  - Keycloak integration for secure authentication
- **Bi-directional Keycloak ⇄ DB Sync**
  - DB changes propagated to Keycloak
  - Keycloak changes reflected in DB (polling/webhooks)
- **Audit & Monitoring**
  - Tracks all user operations with geo-location and user-agent
  - Searchable by user, action, and resource
- **Caching**
  - Redis or in-memory cache for read-heavy queries
  - Automatic cache invalidation on user updates
- **Swagger / OpenAPI**
  - Auto-generated API documentation and interactive UI
- **Logging**
  - Structured JSON logs with `tracing` and `tracing-subscriber`
- **NanoID-based IDs**
  - Unique IDs with prefixes (`USR`, `AUD`) for users and audits

---

## Architecture



Frontend / API Consumers
│
▼
Interfaces (routes.rs, handlers.rs, middleware)
│
▼
Application (UserService, AuditService, Commands/Queries, DTOs)
│
▼
Domain (Entities, Value Objects, Events)
│
▼
Infrastructure (Postgres Repositories, Cache, Keycloak Client, GeoIP)
│
▼
Keycloak & PostgreSQL


**Layers:**
- **Domain:** Business entities, value objects, events
- **Application:** Use cases, commands, queries, DTOs
- **Infrastructure:** Repositories, Keycloak client, cache, geo-IP
- **Interfaces:** HTTP routes, handlers, middleware, Swagger/OpenAPI

---

## Endpoints

### Health & System
- `GET /health` – Health check
- `GET /metrics` – Metrics (optional)

### Authentication
- `POST /login` – Login (returns JWT)
- `POST /refresh` – Refresh token
- `GET /me` – Get current user profile

### External Users
- `POST /users/register` – Self-registration
- `GET /users/verify?token=...` – Email verification

### Admin/Internal Users
- `POST /admin/users` – Create user
- `GET /admin/users/{id}` – Get user by ID
- `GET /admin/users` – Search users
- `PUT /admin/users/{id}` – Update user
- `DELETE /admin/users/{id}` – Deactivate/delete user

### Roles / Access Control
- `GET /roles` – List roles
- `GET /users/{id}/roles` – Get user roles
- `PUT /users/{id}/roles` – Update roles

### Audit
- `GET /audit` – List audit logs
- `GET /audit/{id}` – Get specific audit

### Keycloak Sync
- `POST /sync/keycloak` – Manual DB → Keycloak sync
- `POST /sync/keycloak/poll` – Poll Keycloak → DB sync

### Cache
- `POST /cache/clear` – Clear all cache
- `POST /cache/clear/{user_id}` – Clear cache for specific user

### Swagger / OpenAPI
- `GET /swagger-ui` – Swagger UI
- `GET /openapi.json` – OpenAPI JSON

---

## Tech Stack

- **Rust** – Language
- **Actix-Web + Actix-CORS** – Web framework
- **PostgreSQL + SQLx** – Database
- **Keycloak** – Identity & access management
- **Redis / In-Memory** – Cache
- **Tracing / Tracing-subscriber** – Logging
- **Anyhow / Thiserror** – Error handling
- **Utoipa / Utoipa-Swagger-UI** – OpenAPI documentation
- **Dotenvy** – Environment variable management

---

## Setup & Run

1. **Clone the repository**

```bash
git clone <repo-url>
cd auth-service


Setup environment

cp .env.example .env
# configure DATABASE_URL, SERVER_HOST, SERVER_PORT, Keycloak details


Run Docker Compose (Postgres + Keycloak)

docker-compose up -d


Run migrations

./scripts/migrate.sh


Start the service

cargo run


Access Swagger UI

http://localhost:3000/swagger-ui

Database Migrations

Migrations are stored in the migrations/ folder:

001_create_users.sql – Users table

002_create_audits.sql – Audit table

003_create_outbox_events.sql – Domain events / outbox

004_indexes.sql – Useful indexes for performance

Bi-directional Keycloak Sync

DB → Keycloak: Domain events trigger Keycloak user creation/update/deletion

Keycloak → DB: Scheduled polling or webhooks update DB for changes

Audit and cache invalidation are triggered on both sides

Audit Logging

Stores user actions, timestamp, geographic location, user-agent

Searchable via /audit endpoints

Automatically triggered on create/update/delete actions

License

This project is licensed under the MIT License.

Notes

All IDs use NanoID with prefixes (USR for users, AUD for audit entries)

Commands and Queries follow CQRS pattern

All endpoints are secured using JWT + Keycloak roles

Caching is optional but recommended for high read loads